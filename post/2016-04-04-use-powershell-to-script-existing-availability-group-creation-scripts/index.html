<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Use PowerShell to script existing Availability Group creation scripts! - cjsommer.com</title>
<meta name=description content="Scripts that write scripts! One of my favorites!
So last night I was up working on an issue with an Availability Group. For whatever reason the cluster resource for the AG would not come online. Looking in SSMS the AG&rsquo;s on both replicas were stuck in &ldquo;Resolving&rdquo;. I beat on the keyboard for almost 2 hours before deciding that rebuilding the AG was my best option. The databases were down and the birds were starting to chirp and I needed to get them back online."><meta name=author content="Chris Sommer"><script type=application/ld+json>{"@context":"http://schema.org","@type":"WebSite","name":"cjsommer.com","url":"https:\/\/uwww.cjsommer.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Organization","name":"","url":"https:\/\/uwww.cjsommer.com"}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https:\/\/uwww.cjsommer.com","name":"home"}},{"@type":"ListItem","position":3,"item":{"@id":"https:\/\/uwww.cjsommer.com\/post\/2016-04-04-use-powershell-to-script-existing-availability-group-creation-scripts\/","name":"Use power shell to script existing availability group creation scripts!"}}]}</script><script type=application/ld+json>{"@context":"http://schema.org","@type":"Article","author":{"name":"cjsommer@gmail.com"},"headline":"Use PowerShell to script existing Availability Group creation scripts!","description":"Scripts that write scripts! One of my favorites!\nSo last night I was up working on an issue with an Availability Group. For whatever reason the cluster resource for the AG would not come online. Looking in SSMS the AG\u0026rsquo;s on both replicas were stuck in \u0026ldquo;Resolving\u0026rdquo;. I beat on the keyboard for almost 2 hours before deciding that rebuilding the AG was my best option. The databases were down and the birds were starting to chirp and I needed to get them back online.","inLanguage":"en","wordCount":876,"datePublished":"2016-04-04T10:00:00","dateModified":"2016-04-04T10:00:00","image":"https:\/\/uwww.cjsommer.com\/img\/cjsommer-avatar-2.jpg","keywords":["Powershell, SQL Server"],"mainEntityOfPage":"https:\/\/uwww.cjsommer.com\/post\/2016-04-04-use-powershell-to-script-existing-availability-group-creation-scripts\/","publisher":{"@type":"Organization","name":"https:\/\/uwww.cjsommer.com","logo":{"@type":"ImageObject","url":"https:\/\/uwww.cjsommer.com\/img\/cjsommer-avatar-2.jpg","height":60,"width":60}}}</script><meta property="og:title" content="Use PowerShell to script existing Availability Group creation scripts!"><meta property="og:description" content="Scripts that write scripts! One of my favorites!
So last night I was up working on an issue with an Availability Group. For whatever reason the cluster resource for the AG would not come online. Looking in SSMS the AG&rsquo;s on both replicas were stuck in &ldquo;Resolving&rdquo;. I beat on the keyboard for almost 2 hours before deciding that rebuilding the AG was my best option. The databases were down and the birds were starting to chirp and I needed to get them back online."><meta property="og:image" content="https://uwww.cjsommer.com/img/cjsommer-avatar-2.jpg"><meta property="og:url" content="https://uwww.cjsommer.com/post/2016-04-04-use-powershell-to-script-existing-availability-group-creation-scripts/"><meta property="og:type" content="website"><meta property="og:site_name" content="cjsommer.com"><meta name=twitter:title content="Use PowerShell to script existing Availability Group creation scripts!"><meta name=twitter:description content="Scripts that write scripts! One of my favorites!
So last night I was up working on an issue with an Availability Group. For whatever reason the cluster resource for the AG would not come online. â€¦"><meta name=twitter:image content="https://uwww.cjsommer.com/img/cjsommer-avatar-2.jpg"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@sommerc70"><meta name=twitter:creator content="@sommerc70"><link href=https://uwww.cjsommer.com/img/favicon.ico rel=icon type=image/x-icon><meta name=generator content="Hugo 0.120.4"><link rel=alternate href=https://uwww.cjsommer.com/index.xml type=application/rss+xml title=cjsommer.com><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css integrity=sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI crossorigin=anonymous><link rel=stylesheet href=https://use.fontawesome.com/releases/v5.5.0/css/all.css integrity=sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css integrity=sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu crossorigin=anonymous><link rel=stylesheet href=https://uwww.cjsommer.com/css/main.css><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic"><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800"><link rel=stylesheet href=https://uwww.cjsommer.com/css/highlight.min.css><link rel=stylesheet href=https://uwww.cjsommer.com/css/codeblock.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css integrity=sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css integrity=sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R crossorigin=anonymous></head><body><nav class="navbar navbar-default navbar-fixed-top navbar-custom"><div class=container-fluid><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#main-navbar>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span>
</button>
<a class=navbar-brand href=https://uwww.cjsommer.com>cjsommer.com</a></div><div class="collapse navbar-collapse" id=main-navbar><ul class="nav navbar-nav navbar-right"><li><a title=Home href=/>Home</a></li><li><a title="SQL Server" href=/tags/sql-server/>SQL Server</a></li><li><a title=PowerShell href=/tags/powershell/>PowerShell</a></li><li><a title=Professional href=/tags/professional/>Professional</a></li><li><a title=About href=/page/about/>About</a></li></ul></div><div class=avatar-container><div class=avatar-img-border><a title=cjsommer.com href=https://uwww.cjsommer.com><img class=avatar-img src=https://uwww.cjsommer.com/img/cjsommer-avatar-2.jpg alt=cjsommer.com></a></div></div></div></nav><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><header class=header-section><div class="intro-header no-img"><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><h1>Use PowerShell to script existing Availability Group creation scripts!</h1><span class=post-meta><i class="fas fa-calendar"></i>&nbsp;Posted on April 4, 2016
&nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;876&nbsp;words</span></div></div></div></div></div></header><div class=container role=main><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><article role=main class=blog-post><p>Scripts that write scripts! One of my favorites!</p><p>So last night I was up working on an issue with an Availability Group. For whatever reason the cluster resource for the AG would not come online. Looking in SSMS the AG&rsquo;s on both replicas were stuck in &ldquo;Resolving&rdquo;. I beat on the keyboard for almost 2 hours before deciding that rebuilding the AG was my best option. The databases were down and the birds were starting to chirp and I needed to get them back online.</p><p>If you&rsquo;ve ever built an Availability Group before you know it&rsquo;s not horribly difficult, but you need some critical pieces of information. Replica Names, Endpoint Port Numbers, Availability Group Name, Listener Name, Listener IP&rsquo;s and all of the configurations that go along with it.</p><p>So I found myself scrounging for this information in the wee hours of the morning, hoping I wouldn&rsquo;t miss anything before I removed the AG from SQL Server. In the words of my old boss, &ldquo;hope is not a strategy&rdquo;. Thankfully I had captured all of the information I needed and was able to rebuild the AG successfully. Problem solved&mldr;this time.</p><p>In retrospective I wish I would have had scripts to recreate the AG&rsquo;s. I know not everyone likes to script out all of their work. Some people prefer the GUI, that&rsquo;s fine. But at 2:00 AM the last thing I want to be searching for is this information in hopes that I get it all correct. I know someone is going to say &ldquo;it should be in the run book or in the build documentation&rdquo;. If that documentation is static there&rsquo;s a good chance that it is out of date. Static documentation is only good as long as people are religious about maintaining it, and on a team of 8 DBA&rsquo;s that&rsquo;s usually not the case. I like dynamic documentation. Documentation that is created from the live, running system.</p><p>Which brings me to the point of this blog post. I decided after last night&rsquo;s &ldquo;fun&rdquo; that I would create a script to create a script for rebuilding my AG&rsquo;s. As I said at the beginning, scripts that create scripts are one of my favorite things to do.</p><p>So I started down the T-SQL path and in case you haven&rsquo;t worked with the HADR system tables yet, let me just say it takes a while to find the info you need sometimes. The information you need is in there, but it usually takes me multiple JOINS and multiple cuss words before I get a query that does what I need it to do. Being a PowerShell guy a light bulb went off. I have used the SMO scripter object to script database objects before. What if I could script out AG objects as well? Sure enough, the answer is yes!</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># SQL Server you want to run this against</span>
</span></span><span class=line><span class=cl><span class=nv>$SQLServer</span> <span class=p>=</span> <span class=s1>&#39;SQLINST1\INST1&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Setup pathing and environment based on the script location</span>
</span></span><span class=line><span class=cl><span class=nv>$Invocation</span> <span class=p>=</span> <span class=p>(</span><span class=nb>Get-Variable</span> <span class=n>MyInvocation</span> <span class=n>-Scope</span> <span class=mf>0</span><span class=p>).</span><span class=py>Value</span>
</span></span><span class=line><span class=cl><span class=nv>$ScriptLocation</span> <span class=p>=</span> <span class=nb>Split-Path</span> <span class=nv>$Invocation</span><span class=p>.</span><span class=py>MyCommand</span><span class=p>.</span><span class=py>Path</span>
</span></span><span class=line><span class=cl><span class=nv>$ScriptName</span> <span class=p>=</span> <span class=nv>$Invocation</span><span class=p>.</span><span class=py>MyCommand</span><span class=p>.</span><span class=py>Name</span><span class=p>.</span><span class=py>Replace</span><span class=p>(</span><span class=s2>&#34;.ps1&#34;</span><span class=p>,</span><span class=s2>&#34;&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nv>$ScriptFullPath</span> <span class=p>=</span> <span class=nv>$Invocation</span><span class=p>.</span><span class=py>MyCommand</span><span class=p>.</span><span class=py>Path</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c># Load SMO</span>
</span></span><span class=line><span class=cl><span class=p>[</span><span class=no>System.Reflection.Assembly</span><span class=p>]::</span><span class=n>LoadWithPartialName</span><span class=p>(</span><span class=s2>&#34;Microsoft.SqlServer.SMO&#34;</span><span class=p>)</span> <span class=p>|</span> <span class=nb>out-null</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>$SQLObj</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=s2>&#34;Microsoft.SqlServer.Management.Smo.Server&#34;</span> <span class=nv>$SQLServer</span>
</span></span><span class=line><span class=cl><span class=nv>$SQLObj</span><span class=p>.</span><span class=py>ConnectionContext</span><span class=p>.</span><span class=py>Connect</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>foreach</span> <span class=p>(</span><span class=nv>$ag</span> <span class=k>in</span> <span class=p>(</span><span class=nv>$SQLObj</span><span class=p>.</span><span class=py>AvailabilityGroups</span> <span class=p>)){</span>
</span></span><span class=line><span class=cl>    <span class=nv>$SQLINST</span> <span class=p>=</span> <span class=nv>$SQLServer</span><span class=p>.</span><span class=py>Replace</span><span class=p>(</span><span class=s1>&#39;\&#39;</span><span class=p>,</span><span class=s1>&#39;_&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>$AGName</span> <span class=p>=</span> <span class=nv>$ag</span><span class=p>.</span><span class=py>Name</span>
</span></span><span class=line><span class=cl>    <span class=nv>$Dttm</span> <span class=p>=</span> <span class=p>(</span><span class=nb>Get-Date</span> <span class=n>-Format</span> <span class=s1>&#39;yyyyMMdd_hhmm&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$OutFile</span> <span class=p>=</span> <span class=s2>&#34;</span><span class=nv>$ScriptLocation</span><span class=s2>\AGInfo\</span><span class=nv>$SQLINST</span><span class=s2>\</span><span class=nv>${AGname}</span><span class=s2>_</span><span class=nv>${Dttm}</span><span class=s2>.sql&#34;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(!(</span><span class=nb>Test-Path</span> <span class=n>-Path</span> <span class=nv>$OutFile</span> <span class=n>-PathType</span> <span class=n>Leaf</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>New-Item</span> <span class=n>-Path</span> <span class=nv>$OutFile</span> <span class=n>-ItemType</span> <span class=n>File</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=nb>Write-output</span> <span class=s2>&#34;Scripting Availability Group [</span><span class=nv>$AGName</span><span class=s2>] to &#39;</span><span class=nv>$OutFile</span><span class=s2>&#39;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;/*&#39;</span> <span class=p>|</span> <span class=nb>Out-File</span> <span class=n>-FilePath</span> <span class=nv>$OutFile</span> <span class=n>-Encoding</span> <span class=n>ASCII</span> <span class=n>-Force</span>
</span></span><span class=line><span class=cl>    <span class=nv>$ag</span> <span class=p>|</span> <span class=nb>Select-Object</span> <span class=n>-Property</span> <span class=p>*</span> <span class=p>|</span> <span class=nb>Out-File</span> <span class=n>-FilePath</span> <span class=nv>$OutFile</span> <span class=n>-Encoding</span> <span class=n>ASCII</span> <span class=n>-Append</span>
</span></span><span class=line><span class=cl>    <span class=s1>&#39;*/&#39;</span> <span class=p>|</span> <span class=nb>Out-File</span> <span class=n>-FilePath</span> <span class=nv>$OutFile</span> <span class=n>-Encoding</span> <span class=n>ASCII</span> <span class=n>-Append</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=nv>$scriptr</span> <span class=p>=</span> <span class=nb>new-object</span> <span class=p>(</span><span class=s1>&#39;Microsoft.SqlServer.Management.Smo.Scripter&#39;</span><span class=p>)</span> <span class=p>(</span><span class=nv>$SQLObj</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=nv>$scriptr</span><span class=p>.</span><span class=py>Script</span><span class=p>(</span><span class=nv>$ag</span><span class=p>)</span> <span class=p>|</span> <span class=nb>Out-File</span> <span class=n>-FilePath</span> <span class=nv>$OutFile</span> <span class=n>-Encoding</span> <span class=n>ASCII</span> <span class=n>-Append</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The PowerShell script saves the T-SQL script in a sub-directory under the location where ScriptMyAvailabilityGroups.ps1 lives.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>cjsommer</span><span class=p>\</span><span class=n>Documents</span><span class=p>\</span><span class=n>WindowsPowerShell</span><span class=p>\</span><span class=n>AGInfo</span><span class=p>\</span><span class=n>SQLINST1_INST1</span> <span class=p>[</span><span class=n>master</span> <span class=mf>+3</span> <span class=p>~</span><span class=mf>1</span> <span class=mf>-0</span> <span class=p>!]&gt;</span> <span class=nb>ls
</span></span></span><span class=line><span class=cl><span class=nb></span>
</span></span><span class=line><span class=cl>    <span class=n>Directory</span><span class=err>:</span> <span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>cjsommer</span><span class=p>\</span><span class=n>Documents</span><span class=p>\</span><span class=n>WindowsPowerShell</span><span class=p>\</span><span class=n>AGInfo</span><span class=p>\</span><span class=n>SQLINST1_INST1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Mode</span>                <span class=n>LastWriteTime</span>     <span class=n>Length</span> <span class=n>Name</span>
</span></span><span class=line><span class=cl><span class=p>----</span>                <span class=p>-------------</span>     <span class=p>------</span> <span class=p>----</span>
</span></span><span class=line><span class=cl><span class=n>-a</span><span class=p>---</span>        <span class=mf>2016</span><span class=p>-</span><span class=mf>04</span><span class=p>-</span><span class=mf>01</span>     <span class=mf>13</span><span class=err>:</span><span class=mf>41</span>       <span class=mf>2388</span> <span class=n>MYAG1_20160401_0139</span><span class=p>.</span><span class=py>sql</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>C:</span><span class=p>\</span><span class=n>Users</span><span class=p>\</span><span class=n>cjsommer</span><span class=p>\</span><span class=n>Documents</span><span class=p>\</span><span class=n>WindowsPowerShell</span><span class=p>\</span><span class=n>AGInfo</span><span class=p>\</span><span class=n>SQLINST1_INST1</span> <span class=p>[</span><span class=n>master</span> <span class=mf>+3</span> <span class=p>~</span><span class=mf>1</span> <span class=mf>-0</span> <span class=p>!]&gt;</span>
</span></span></code></pre></div><p>And here are the contents of the T-SQL script that was generated.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-sql data-lang=sql><span class=line><span class=cl><span class=n>Parent</span><span class=w>                     </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=n>SQLINST1</span><span class=err>\</span><span class=n>INST1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>AutomatedBackupPreference</span><span class=w>  </span><span class=p>:</span><span class=w> </span><span class=n>Secondary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>BasicAvailabilityGroup</span><span class=w>     </span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DatabaseHealthTrigger</span><span class=w>      </span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DtcSupportEnabled</span><span class=w>          </span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>FailureConditionLevel</span><span class=w>      </span><span class=p>:</span><span class=w> </span><span class=n>OnCriticalServerErrors</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>HealthCheckTimeout</span><span class=w>         </span><span class=p>:</span><span class=w> </span><span class=mi>30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ID</span><span class=w>                         </span><span class=p>:</span><span class=w> </span><span class=mi>65536</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>LocalReplicaRole</span><span class=w>           </span><span class=p>:</span><span class=w> </span><span class=k>Primary</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>PrimaryReplicaServerName</span><span class=w>   </span><span class=p>:</span><span class=w> </span><span class=n>SQLINST1</span><span class=err>\</span><span class=n>INST1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>UniqueId</span><span class=w>                   </span><span class=p>:</span><span class=w> </span><span class=mi>646</span><span class=n>cf943</span><span class=o>-</span><span class=n>a4b5</span><span class=o>-</span><span class=mi>406</span><span class=n>d</span><span class=o>-</span><span class=mi>8</span><span class=n>c75</span><span class=o>-</span><span class=mi>29</span><span class=n>ffd7e6424e</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>AvailabilityReplicas</span><span class=w>       </span><span class=p>:</span><span class=w> </span><span class=err>{</span><span class=n>SQLINST1</span><span class=err>\</span><span class=n>INST1</span><span class=p>,</span><span class=w> </span><span class=n>SQLINST2</span><span class=err>\</span><span class=n>INST1</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>AvailabilityDatabases</span><span class=w>      </span><span class=p>:</span><span class=w> </span><span class=err>{</span><span class=n>UserDB1</span><span class=p>,</span><span class=w> </span><span class=n>UserDB2</span><span class=p>...</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>DatabaseReplicaStates</span><span class=w>      </span><span class=p>:</span><span class=w> </span><span class=err>{</span><span class=n>MYAG1</span><span class=p>,</span><span class=w> </span><span class=n>MYAG1</span><span class=p>,</span><span class=w> </span><span class=n>MYAG1</span><span class=p>,</span><span class=w> </span><span class=n>MYAG1</span><span class=p>...</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>AvailabilityGroupListeners</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=err>{</span><span class=n>MYLSNR1</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Name</span><span class=w>                       </span><span class=p>:</span><span class=w> </span><span class=n>MYAG1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Urn</span><span class=w>                        </span><span class=p>:</span><span class=w> </span><span class=n>Server</span><span class=p>[</span><span class=o>@</span><span class=n>Name</span><span class=o>=</span><span class=s1>&#39;SQLINST1\INST1&#39;</span><span class=p>]</span><span class=o>/</span><span class=n>AvailabilityGroup</span><span class=p>[</span><span class=o>@</span><span class=n>Name</span><span class=o>=</span><span class=s1>&#39;MYAG1&#39;</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>Properties</span><span class=w>                 </span><span class=p>:</span><span class=w> </span><span class=err>{</span><span class=n>Name</span><span class=o>=</span><span class=n>AutomatedBackupPreference</span><span class=o>/</span><span class=k>Type</span><span class=o>=</span><span class=n>Microsoft</span><span class=p>.</span><span class=n>SqlServer</span><span class=p>.</span><span class=n>Management</span><span class=p>.</span><span class=n>Smo</span><span class=p>.</span><span class=n>AvailabilityGroupAutomatedBackupPreference</span><span class=o>/</span><span class=n>Writable</span><span class=o>=</span><span class=k>True</span><span class=o>/</span><span class=n>Value</span><span class=o>=</span><span class=n>Secondary</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                             </span><span class=n>Name</span><span class=o>=</span><span class=n>FailureConditionLevel</span><span class=o>/</span><span class=k>Type</span><span class=o>=</span><span class=n>Microsoft</span><span class=p>.</span><span class=n>SqlServer</span><span class=p>.</span><span class=n>Management</span><span class=p>.</span><span class=n>Smo</span><span class=p>.</span><span class=n>AvailabilityGroupFailureConditionLevel</span><span class=o>/</span><span class=n>Writable</span><span class=o>=</span><span class=k>True</span><span class=o>/</span><span class=n>Value</span><span class=o>=</span><span class=n>OnCriticalServerErrors</span><span class=p>,</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w>                             </span><span class=n>Name</span><span class=o>=</span><span class=n>HealthCheckTimeout</span><span class=o>/</span><span class=k>Type</span><span class=o>=</span><span class=k>System</span><span class=p>.</span><span class=n>Int32</span><span class=o>/</span><span class=n>Writable</span><span class=o>=</span><span class=k>True</span><span class=o>/</span><span class=n>Value</span><span class=o>=</span><span class=mi>30000</span><span class=p>,</span><span class=w> </span><span class=n>Name</span><span class=o>=</span><span class=n>ID</span><span class=o>/</span><span class=k>Type</span><span class=o>=</span><span class=k>System</span><span class=p>.</span><span class=n>Int32</span><span class=o>/</span><span class=n>Writable</span><span class=o>=</span><span class=k>False</span><span class=o>/</span><span class=n>Value</span><span class=o>=</span><span class=mi>65536</span><span class=p>...</span><span class=err>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>ExecutionManager</span><span class=w>           </span><span class=p>:</span><span class=w> </span><span class=n>Microsoft</span><span class=p>.</span><span class=n>SqlServer</span><span class=p>.</span><span class=n>Management</span><span class=p>.</span><span class=n>Smo</span><span class=p>.</span><span class=n>ExecutionManager</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=n>UserData</span><span class=w>                   </span><span class=p>:</span><span class=w> 
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>State</span><span class=w>                      </span><span class=p>:</span><span class=w> </span><span class=k>Existing</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>*/</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>CREATE</span><span class=w> </span><span class=n>AVAILABILITY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>GROUP</span><span class=w> </span><span class=p>[</span><span class=n>MYAG1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>AUTOMATED_BACKUP_PREFERENCE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SECONDARY</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>FAILURE_CONDITION_LEVEL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>HEALTH_CHECK_TIMEOUT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>30000</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>FOR</span><span class=w> </span><span class=k>DATABASE</span><span class=w> </span><span class=p>[</span><span class=n>UserDB1</span><span class=p>]</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>,[</span><span class=n>UserDB2</span><span class=p>]</span><span class=w> </span><span class=n>REPLICA</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>N</span><span class=s1>&#39;SQLINST1\INST1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>ENDPOINT_URL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>N</span><span class=s1>&#39;TCP://SQLINST1.mydomain.com:5022&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>FAILOVER_MODE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MANUAL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>AVAILABILITY_MODE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SYNCHRONOUS_COMMIT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>SESSION_TIMEOUT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>BACKUP_PRIORITY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>PRIMARY_ROLE</span><span class=p>(</span><span class=n>ALLOW_CONNECTIONS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>ALL</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>SECONDARY_ROLE</span><span class=p>(</span><span class=n>ALLOW_CONNECTIONS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>NO</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=p>,</span><span class=n>N</span><span class=s1>&#39;SQLINST2\INST1&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=k>WITH</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=n>ENDPOINT_URL</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>N</span><span class=s1>&#39;TCP://SQLINST2.mydomain.com:5022&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>FAILOVER_MODE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MANUAL</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>AVAILABILITY_MODE</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>SYNCHRONOUS_COMMIT</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>SESSION_TIMEOUT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>BACKUP_PRIORITY</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>50</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>PRIMARY_ROLE</span><span class=p>(</span><span class=n>ALLOW_CONNECTIONS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>ALL</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>,</span><span class=n>SECONDARY_ROLE</span><span class=p>(</span><span class=n>ALLOW_CONNECTIONS</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>NO</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>)</span><span class=w> </span><span class=n>LISTENER</span><span class=w> </span><span class=n>N</span><span class=s1>&#39;MYLSNR1&#39;</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=k>WITH</span><span class=w> </span><span class=n>IP</span><span class=p>((</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=n>N</span><span class=s1>&#39;192.168.0.100&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=p>,</span><span class=n>N</span><span class=s1>&#39;255.255.255.0&#39;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>					</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>			</span><span class=p>,</span><span class=n>PORT</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1433</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>		</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><p>So that&rsquo;s that. It&rsquo;s a pretty simple PowerShell script that provide you with an up to date T-SQL script that will be useful if you ever end up having to rebuild your AGs at 2:00 AM like I did last night. There is obviously (or not so obviously) a lot of things you could do to customize it and make it your own. Enjoy and happy scripting!</p><div class=blog-tags><a href=https://uwww.cjsommer.com/tags/powershell/>Powershell</a>&nbsp;
<a href=https://uwww.cjsommer.com/tags/sql-server/>SQL Server</a>&nbsp;</div><hr><section id=social-share><div class="list-inline footer-links"><div class=share-box aria-hidden=true><ul class=share><li><a href="//twitter.com/share?url=https%3a%2f%2fuwww.cjsommer.com%2fpost%2f2016-04-04-use-powershell-to-script-existing-availability-group-creation-scripts%2f&amp;text=Use%20PowerShell%20to%20script%20existing%20Availability%20Group%20creation%20scripts%21&amp;via=sommerc70" target=_blank title="Share on Twitter"><i class="fab fa-twitter"></i></a></li><li><a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fuwww.cjsommer.com%2fpost%2f2016-04-04-use-powershell-to-script-existing-availability-group-creation-scripts%2f" target=_blank title="Share on Facebook"><i class="fab fa-facebook"></i></a></li><li><a href="//reddit.com/submit?url=https%3a%2f%2fuwww.cjsommer.com%2fpost%2f2016-04-04-use-powershell-to-script-existing-availability-group-creation-scripts%2f&amp;title=Use%20PowerShell%20to%20script%20existing%20Availability%20Group%20creation%20scripts%21" target=_blank title="Share on Reddit"><i class="fab fa-reddit"></i></a></li><li><a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2fuwww.cjsommer.com%2fpost%2f2016-04-04-use-powershell-to-script-existing-availability-group-creation-scripts%2f&amp;title=Use%20PowerShell%20to%20script%20existing%20Availability%20Group%20creation%20scripts%21" target=_blank title="Share on LinkedIn"><i class="fab fa-linkedin"></i></a></li><li><a href="//www.stumbleupon.com/submit?url=https%3a%2f%2fuwww.cjsommer.com%2fpost%2f2016-04-04-use-powershell-to-script-existing-availability-group-creation-scripts%2f&amp;title=Use%20PowerShell%20to%20script%20existing%20Availability%20Group%20creation%20scripts%21" target=_blank title="Share on StumbleUpon"><i class="fab fa-stumbleupon"></i></a></li><li><a href="//www.pinterest.com/pin/create/button/?url=https%3a%2f%2fuwww.cjsommer.com%2fpost%2f2016-04-04-use-powershell-to-script-existing-availability-group-creation-scripts%2f&amp;description=Use%20PowerShell%20to%20script%20existing%20Availability%20Group%20creation%20scripts%21" target=_blank title="Share on Pinterest"><i class="fab fa-pinterest"></i></a></li></ul></div></div></section><h4 class=see-also>See also</h4><ul><li><a href=/post/2020-10-13-qds-gottchas/>QDS Forced Plans - Gotchas and Limitations</a></li><li><a href=/post/2018-03-02-speaking-at-sqlsaturday-723/>SQL Saturday 723, March 24, 2018 in Rochester, NY. Join us and kick your SQL Server knowledge up a notch!</a></li><li><a href=/post/2017-11-14-tsql2sday-96-folks-who-made-a-difference/>T-SQL Tuesday 96 - Folks Who Have Made a Difference</a></li><li><a href=/post/2017-09-11-tsql2sday-94-do-you-wanna-get-posh/>T-SQL Tuesday 94 - Do you wanna get PoSh?</a></li><li><a href=/post/2017-08-28-wilt-configure-tempdb-rds/>What I Learned Today - Configuring tempdb in RDS</a></li></ul></article><ul class="pager blog-pager"><li class=previous><a href=https://uwww.cjsommer.com/post/2016-04-03-speaking-at-sql-saturday-487-in-ottawa-on-april-16-2016/ data-toggle=tooltip data-placement=top title="Speaking at SQL Saturday 487 in Ottawa on April 16, 2016">&larr; Previous Post</a></li><li class=next><a href=https://uwww.cjsommer.com/post/2016-04-12-speaking-at-sql-saturday-526-in-rochester-on-may-14-2016/ data-toggle=tooltip data-placement=top title="Speaking at SQL Saturday 526 in Rochester on May 14, 2016">Next Post &rarr;</a></li></ul></div></div></div><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center footer-links"><li><a href=mailto:cjsommer@gmail.com title="Email me"><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-envelope fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://github.com/cjsommer title=GitHub><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://twitter.com/sommerc70 title=Twitter><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/cjsommer title=LinkedIn><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href title=RSS><span class="fa-stack fa-lg"><i class="fas fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="credits copyright text-muted"><a href=cjsommer.com>Chris Sommer</a>
&nbsp;&bull;&nbsp;&copy;
2020
&nbsp;&bull;&nbsp;
<a href=https://uwww.cjsommer.com>cjsommer.com</a></p><p class="credits theme-by text-muted"><a href=https://gohugo.io>Hugo v0.120.4</a> powered &nbsp;&bull;&nbsp; Theme <a href=https://github.com/halogenica/beautifulhugo>Beautiful Hugo</a> adapted from <a href=https://deanattali.com/beautiful-jekyll/>Beautiful Jekyll</a></p></div></div></div></footer><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js integrity=sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script src=https://code.jquery.com/jquery-3.7.0.slim.min.js integrity=sha384-w5y/xIeYixWvfM+A1cEbmHPURnvyqmVg5eVENruEdDjcyRLUSNej7512JQGspFUr crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js integrity=sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd crossorigin=anonymous></script><script src=https://uwww.cjsommer.com/js/main.js></script><script src=https://uwww.cjsommer.com/js/highlight.min.js></script><script>hljs.initHighlightingOnLoad()</script><script>$(document).ready(function(){$("pre.chroma").css("padding","0")})</script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js integrity=sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js integrity=sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q crossorigin=anonymous></script><script src=https://uwww.cjsommer.com/js/load-photoswipe.js></script></body></html>